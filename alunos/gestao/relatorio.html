{% extends 'base.html' %}
{% load static %}

{% block title %}Relatório a Receber{% endblock %}

{% block content %}
<style>
  * { font-family: 'Inter', sans-serif; }
  .form-label { font-weight: 600; font-size: 0.95rem; }
  .form-input { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.95rem; }
  .btn-filtrar { background-color: #2563eb; color: white; padding: 0.5rem 1rem; font-weight: 500; border-radius: 0.5rem; transition: background 0.3s; text-align: center; display: inline-block; }
  .btn-filtrar:hover { background-color: #1d4ed8; }
  .btn-limpar { background-color: #dc2626; color: white; padding: 0.5rem 1rem; font-weight: 500; border-radius: 0.5rem; transition: background 0.3s; text-align: center; display: inline-block; }
  .btn-limpar:hover { background-color: #b91c1c; }
  .tabela-relatorio { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
  .tabela-relatorio th, .tabela-relatorio td {
    padding: 0.6rem 0.75rem;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.92rem;
  }
  .tabela-relatorio th {
    background-color: #f3f4f6;
    text-align: left;
    font-weight: 600;
  }
  .tabela-relatorio tbody tr:nth-child(even) {
    background-color: #f9fafb;
  }
  .section-title {
    font-size: 1.1rem;
    font-weight: 700;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: #2563eb;
    border-bottom: 2px solid #2563eb;
    padding-bottom: 0.2rem;
  }
  .totais-container {
    display: flex;
    justify-content: flex-end;
    gap: 3rem;
    margin-top: 2rem;
    font-weight: 600;
    font-size: 1rem;
  }
  .total-item {
    display: flex;
    gap: 0.4rem;
    align-items: center;
  }
</style>

<div class="max-w-5xl mx-auto pt-4 animate-fade-in">
  <div class="bg-white rounded-2xl p-6 shadow-md border" style="border-width: 0.5px; border-color: rgba(37, 99, 235, 0.4);">
    <h2 class="text-xl font-bold text-blue-700 mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="svg-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem;">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18M9 17V9M15 17V5" />
      </svg>
      Relatório de Valores Recebidos
    </h2>

    <form method="get" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6 items-end">
      <div>
        <label for="data_inicio" class="form-label">Data Início</label>
        <input type="date" name="data_inicio" id="data_inicio" value="{{ data_inicio|date:'Y-m-d' }}" class="form-input">
      </div>
      <div>
        <label for="data_fim" class="form-label">Data Fim</label>
        <input type="date" name="data_fim" id="data_fim" value="{{ data_fim|date:'Y-m-d' }}" class="form-input">
      </div>
      <div>
        <label for="metodo_pagamento" class="form-label">Método de Pagamento</label>
        <select name="metodo_pagamento" id="metodo_pagamento" class="form-input">
          <option value="">Todos</option>
          {% for metodo in metodos_pagamento %}
            <option value="{{ metodo.id }}" {% if metodo.id|stringformat:"s" == metodo_pagamento_id %}selected{% endif %}>{{ metodo.metodo }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <button type="submit" class="btn-filtrar w-full">Filtrar</button>
      </div>
      <div>
        <a href="{% url 'relatorio_receber' %}" class="btn-limpar w-full">Limpar</a>
      </div>
    </form>

    {# Pagamentos de Alunos #}
    <div>
      <h3 class="section-title">Pagamentos de Alunos</h3>
      <table class="tabela-relatorio">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Valor Pago</th>
            <th>Data Pagamento</th>
            <th>Método</th>
          </tr>
        </thead>
        <tbody>
          {% if alunos %}
            {% for aluno in alunos %}
            <tr>
              <td>{{ aluno.nome }}</td>
              <td>R$ {{ aluno.valor_pago }}</td>
              <td>{{ aluno.data_pagamento|date:'d/m/Y' }}</td>
              <td>{{ aluno.metodo_pagamento }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4" class="text-center text-gray-500 py-4">Nenhum pagamento de aluno encontrado.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {# Vendas de Produtos #}
    <div>
      <h3 class="section-title">Vendas de Produtos</h3>
      <table class="tabela-relatorio">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Valor</th>
            <th>Data Venda</th>
            <th>Método</th>
          </tr>
        </thead>
        <tbody>
          {% if vendas %}
            {% for venda in vendas %}
            <tr>
              <td>{{ venda.nome_produto }}</td>
              <td>R$ {{ venda.valor_produto }}</td>
              <td>{{ venda.data_venda|date:'d/m/Y' }}</td>
              <td>{{ venda.metodo_pagamento }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4" class="text-center text-gray-500 py-4">Nenhuma venda de produto encontrada.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {# Totais lado a lado, texto e valor na mesma linha #}
    <div class="totais-container">
      <div class="total-item">
        <span>Total Pagamentos de Alunos:</span>
        <span>R$ {{ total_pago_alunos }}</span>
      </div>
      <div class="total-item">
        <span>Total Vendas de Produtos:</span>
        <span>R$ {{ total_pago_vendas }}</span>
      </div>
      <div class="total-item">
        <span>Total Geral:</span>
        <span>R$ {{ total_geral }}</span>
      </div>
    </div>

    {# Gráfico pizza menor e mais intuitivo #}
    <div style="max-width: 250px; margin: 1.5rem auto;">
      <canvas id="pagamentosChart" width="250" height="250"></canvas>
    </div>

  </div>
</div>

{# Importa Chart.js #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const ctx = document.getElementById('pagamentosChart').getContext('2d');

  const data = {
    labels: ['Alunos', 'Produtos'],
    datasets: [{
      label: 'Receitas',
      data: [
        {{ total_pago_alunos|default:"0" }},
        {{ total_pago_vendas|default:"0" }}
      ],
      backgroundColor: [
        'rgba(37, 99, 235, 0.8)',    // azul
        'rgba(220, 38, 38, 0.8)'     // vermelho
      ],
      borderColor: [
        'rgba(37, 99, 235, 1)',
        'rgba(220, 38, 38, 1)'
      ],
      borderWidth: 1
    }]
  };

  const config = {
    type: 'pie',
    data: data,
    options: {
      responsive: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            font: {
              size: 12
            },
            padding: 10,
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.label || '';
              let value = context.parsed || 0;
              return label + ': R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
          }
        }
      }
    },
  };

  new Chart(ctx, config);
</script>

{% endblock %}
